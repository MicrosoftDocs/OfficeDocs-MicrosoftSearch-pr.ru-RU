---
title: Azure SQL и Microsoft SQL Graph для Поиска (Майкрософт)
ms.author: mecampos
author: mecampos
manager: umas
ms.audience: Admin
ms.topic: article
ms.service: mssearch
localization_priority: Normal
search.appverid:
- BFB160
- MET150
- MOE150
description: Настройка соединители Azure SQL и Microsoft SQL Graph для Поиска (Майкрософт).
ms.openlocfilehash: 9f0a0a617541c6e27196a183d3283e0f05163dec
ms.sourcegitcommit: d53b91f8f52a4a96281b66831c2449bbffe2177c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "50097442"
---
<!---Previous ms.author: vivg --->

# <a name="azure-sql-and-microsoft-sql-server-graph-connectors"></a>Соединители Graph SQL Azure SQL и Microsoft SQL Server

Сервер Microsoft SQL или соединители Azure SQL Graph позволяют организации обнаруживировать и индексировать данные из локальной базы данных SQL Server или базы данных, которая SQL в вашем экземпляре Azure SQL в облаке.
Соединители Graph индексирует указанное содержимое в Поиск (Майкрософт). Чтобы поддерживать индекс в соответствии с исходными данными, он поддерживает периодические полные и добавонные обходы контента. С помощью этих SQL можно также ограничить доступ к результатам поиска для определенных пользователей.

> [!NOTE]
> Прочитайте [**статью "Настройка соединители Graph",**](configure-connector.md) чтобы ознакомиться с общим процессом настройки соединители Graph.

Эта статья для всех, кто настраивает, запускает и отслеживает соединители Azure SQL и Microsoft SQL Graph. Он дополняет общий процесс настройки и отображает инструкции, применимые только к соединители Azure SQL и Microsoft SQL Graph. В этой статье также [](#limitations) содержатся сведения об ограничениях для сервера Microsoft SQL и соединители Azure SQL.

## <a name="before-you-get-started"></a>Перед началом работы

### <a name="install-the-graph-connector-agent-required-for-on-premises-microsoft-sql-server-connector-only"></a>Установка агента соединителя Graph (требуется только для локального соединителя SQL Microsoft)

Чтобы получить доступ к данным локальной сторонней компании, необходимо установить и настроить агент соединителя Graph. Дополнительные данные см. в подключении к агенту [соединителя Graph.](on-prem-agent.md)  

## <a name="step-1-add-a-graph-connector-in-the-microsoft-365-admin-center"></a>Шаг 1. Добавление соединителю Graph в Центре администрирования Microsoft 365

Следуйте общим [инструкциям по настройке.](https://docs.microsoft.com/microsoftsearch/configure-connector)
<!---If the above phrase does not apply, delete it and insert specific details for your data source that are different from general setup 
instructions.-->

## <a name="step-2-name-the-connection"></a>Шаг 2. Имя подключения

Следуйте общим [инструкциям по настройке.](https://docs.microsoft.com/microsoftsearch/configure-connector)
<!---If the above phrase does not apply, delete it and insert specific details for your data source that are different from general setup 
instructions.-->

## <a name="step-3-configure-the-connection-settings"></a>Шаг 3. Настройка параметров подключения

### <a name="register-an-app-for-azure-sql-connector-only"></a>Регистрация приложения (только для SQL Azure)

Для соедините SQL Azure необходимо зарегистрировать приложение в Azure Active Directory, чтобы разрешить приложению Поиска (Майкрософт) доступ к данным для индексации. Чтобы узнать больше о регистрации приложения, обратитесь к документации Microsoft Graph о том, как [зарегистрировать приложение.](https://docs.microsoft.com/graph/auth-register-app-v2)

После регистрации приложения и заметив имя приложения, ИД приложения (клиента) и ИД клиента, необходимо создать новый [секрет клиента.](https://docs.microsoft.com/azure/healthcare-apis/register-confidential-azure-ad-client-app#application-secret) Секрет клиента будет отображаться только один раз. Не забудьте & безопасно хранить секрет клиента. Используйте ИД и секрет клиента при настройке нового подключения в Поиске (Майкрософт).

Чтобы добавить зарегистрированное приложение в базу данных Azure SQL, необходимо:

- Войдите в свою SQL Azure
- Открытие нового окна запроса
- Создание нового пользователя с помощью команды "СОЗДАТЬ ПОЛЬЗОВАТЕЛЯ [имя приложения] FROM EXTERNAL PROVIDER"
- Чтобы добавить пользователя в роль, с помощью команды "exec sp_addrolemember "db_datareader", [имя приложения]" или "ALTER ROLE db_datareader ADD MEMBER [имя приложения]"

>[!NOTE]
>Чтобы отослаться от доступа к любому приложению, зарегистрированном в Azure Active Directory, обратитесь к документации Azure об удалении [зарегистрированного приложения.](https://docs.microsoft.com/azure/active-directory/develop/quickstart-remove-app)

### <a name="connection-settings"></a>Параметры подключения

Чтобы подключить соединители microsoft SQL server к источнику данных, необходимо настроить сервер базы данных, обход и агент на компьютере. Затем можно подключиться к базе данных с помощью требуемого метода проверки подлинности.

> [!NOTE] 
> Чтобы подключиться к SQL microsoft SQL, в базе данных должен быть SQL сервер версии 2008 или более поздней версии.

Для соедините SQL Azure необходимо указать только имя сервера или IP-адрес, к который требуется подключиться. Соединит SQL Azure поддерживает проверку подлинности azure Active Directory Open ID Connect (OIDC) только для подключения к базе данных.

Для обеспечения безопасности можно настроить правила IP-брандмауэра для сервера SQL azure или базы данных. Чтобы узнать больше о настройке правил ip-брандмауэра, обратитесь к документации по [правилам ip-брандмауэра.](https://docs.microsoft.com/azure/azure-sql/database/firewall-configure) Добавьте следующие диапазоны IP-адресов клиента в параметры брандмауэра.

| Region | Диапазон IP-адресов |
| ------------ | ------------ |
| NAM | 52.250.92.252/30, 52.224.250.216/30 |
| EUR | 20.54.41.208/30, 51.105.159.88/30 |
| APC | 52.139.188.212/30, 20.43.146.44/30 |

Для поиска контента базы данных необходимо указать SQL при настройке соединители. Эти SQL должны называть все столбцы базы данных, которые требуется индексировать (то есть свойства источника), включая все SQL, которые необходимо выполнить для получения всех столбцов. Чтобы ограничить доступ к результатам поиска, необходимо указать списки управления доступом (ALS) в SQL запросов при настройке соединителя.

## <a name="step-3a-full-crawl-required"></a>Шаг 3a. Полный обход контента (обязательно)

На этом этапе настраивается запрос SQL, который выполняет полный обход базы данных. При полном обходе выбираются все столбцы или свойства, для которых нужно выбрать **параметры**"Запрос", "Поиск" или **"Получить".** Можно также указать столбцы ACL, чтобы ограничить доступ к результатам поиска определенным пользователям или группам.

> [!Tip]
> Чтобы получить все необходимые столбцы, можно присоединить несколько таблиц.

![Сценарий, показывающий OrderTable и AclTable с примерами свойств](media/MSSQL-fullcrawl.png)

### <a name="select-data-columns-required-and-acl-columns-optional"></a>Выбор столбцов данных (обязательно) и столбцов ACL (необязательно)

В примере демонстрируется выбор пяти столбцов данных, в которые будут вметься данные для поиска: OrderId, OrderTitle, OrderDesc, CreatedDateTime и IsDeleted. Чтобы настроить разрешения на просмотр для каждой строки данных, можно при желании выбрать такие столбцы ACL: AllowedUsers, AllowedGroups, DeniedUsers и DeniedGroups. Все эти столбцы данных также имеют параметры **"Запрос",** **"Поиск"** или **"Получить".**

Выберите столбцы данных, как показано в этом примере запроса: `SELECT OrderId, OrderTitle, OrderDesc, AllowedUsers, AllowedGroups, DeniedUsers, DeniedGroups, CreatedDateTime, IsDeleted`

Для управления доступом к результатам поиска можно указать один или несколько столбцов ACL в запросе. Соединитель SQL позволяет управлять доступом на уровне записи. Вы можете выбрать один и тот же контроль доступа для всех записей в таблице. Если данные ACL хранятся в отдельной таблице, может потребоваться объединить эти таблицы в запросе.

Ниже описано использование каждого из столбцов ACL в приведенного выше запросе. В следующем списке поясняются четыре механизма **контроля доступа.**

- **AllowedUsers**: в этом столбце указывается список ИД пользователей, которые могут получить доступ к результатам поиска. В следующем примере список пользователей: john@contoso.com, keith@contoso.com и lisa@contoso.com будут иметь доступ только к записи с OrderId = 12.
- **AllowedGroups**: в этом столбце указывается группа пользователей, которые смогут получать доступ к результатам поиска. В следующем примере группа sales-team@contoso.com иметь доступ только к записи с orderId = 12.
- **DeniedUsers**: в этом столбце указывается список **пользователей,** у которых нет доступа к результатам поиска. В следующем примере пользователи, john@contoso.com и keith@contoso.com не имеют доступа к записи с orderId = 13, тогда как все остальные имеют доступ к этой записи.
- **DeniedGroups**: в этом столбце указывается группа **пользователей,** у которых нет доступа к результатам поиска. В следующем примере группы engg-team@contoso.com и pm-team@contoso.com не имеют доступа к записи с orderId = 15, тогда как все остальные имеют доступ к этой записи.  

![Демонстрация данных с примерами свойств OrderTable и AclTable](media/MSSQL-ACL1.png)

### <a name="supported-data-types"></a>Поддерживаемые типы данных

В приведенной ниже таблице SQL типы данных, поддерживаемые соединитетелями MS SQL и Azure SQL. В таблице также приводится итог типа данных индексации для поддерживаемого SQL данных. Дополнительные сведения о соединитах Microsoft Graph, поддерживаемых типами данных для индексирования, можно найти в документации по [типам ресурсов свойств.](https://docs.microsoft.com/graph/api/resources/property?view=graph-rest-beta#properties&preserve-view=true)

| Category | Тип исходных данных | Тип данных индексации |
| ------------ | ------------ | ------------ |
| дата и время; | date <br> datetime <br> datetime2 <br> smalldatetime | datetime |
| Точное число | bigint <br> int <br> smallint <br> tinyint | int64 |
| Точное число | bit | boolean |
| Приблизительное число | float <br> real | double |
| Строка символов | char <br> varchar <br> text | string |
| Строки символов Юникода | nchar <br> nvarchar <br> ntext | string |
| Другие типы данных | uniqueidentifier | string |

Для любого другого типа данных, который в настоящее время не поддерживается напрямую, столбец необходимо явно привести к поддерживаемый тип данных.

### <a name="watermark-required"></a>Водяной знак (обязательно)

Чтобы предотвратить перегрузку базы данных, соединители пакетно и возобновляют запросы полного обхода с помощью столбца подстановки для полного обхода. Используя значение столбца водяного знака, получается каждый последующий пакет, и запросы возобновляются с последней контрольной точки. По сути, этот механизм управляет обновлением данных при полном обходе контента.

Создайте фрагменты запроса для водяных знаков, как показано в этих примерах:

- `WHERE (CreatedDateTime > @watermark)`. Уберем имя столбца водяного знака с зарезервированным ключевым `@watermark` словом. Если порядок сортировки столбца водяного знака возрастает, `>` используйте; в противном случае используйте `<` .
- `ORDER BY CreatedDateTime ASC`. Сортировать столбец водяного знака по возрастанию или убыванию.

В конфигурации, показанной на следующем изображении, `CreatedDateTime` выбран столбец водяного знака. Чтобы получить первый пакет строк, укажите тип данных столбца водяного знака. В этом случае типом данных является `DateTime` .

![Конфигурация столбцов водяного знака](media/MSSQL-watermark.png)

Первый запрос получает первое **N** число строк с помощью: "CreatedDateTime > January 1, 1753 00:00:00" (min value of DateTime data type). После получения первого пакета максимальное значение, возвращаемого в пакете, будет сохранено в качестве контрольной точки, если строки сортироваться в порядке `CreatedDateTime` возрастания. Пример: 1 марта 2019 г. 03:00:00. Затем следующий пакет строк **N** получается с помощью "CreatedDateTime > March 1, 2019 03:00:00" в запросе.

### <a name="skipping-soft-deleted-rows-optional"></a>Пропуск необязательных строк (необязательно)

Чтобы исключить из индексации удаленные строки в базе данных, укажите имя и значение столбца с возможностью мягкого удаления, указывав на то, что строка удаляется.

![Параметры мягкого удаления: "Soft delete column" и "Value of soft delete column which indicates a deleted row"](media/MSSQL-softdelete.png)

### <a name="full-crawl-manage-search-permissions"></a>Полный обход контента: управление разрешениями поиска

Выберите **"Управление разрешениями",** чтобы выбрать различные столбцы управления доступом (ACL), которые определяют механизм управления доступом. Выберите имя столбца, указанное в запросе полного SQL обхода.

Каждый столбец ACL должен быть столбцом с несколькими значениями. Эти несколько значений ID могут быть разделены разделиаторами, такими как точка с запятой (;), запятая (,) и так далее. Этот сепаратор необходимо указать в **поле".**

Следующие типы ID поддерживаются для использования в качестве ALS:

- **Имя основного пользователя (UPN)**— это имя пользователя системы в формате адреса электронной почты. Имя пользователя (например, john.doe@domain.com) состоит из имени пользователя (имя для регистрации), сепаратора (символ @) и доменного имени (суффикс имени пользователя).
- **Azure Active Directory (AAD) ID**: в Azure AD каждый пользователь или группа имеет объектный ИД, который выглядит как "e0d3ad3d-0000-1111-2222-3c5f5c52ab9b".
- Идентификатор безопасности **Active Directory (AD):** в локальной установке AD у каждого пользователя и группы есть не изменяемый уникальный идентификатор безопасности, который выглядит как "S-1-5-21-3878594291-2115959936-132693609-65242".

![Параметры разрешений поиска для настройки списков управления доступом](media/MSSQL-ACL2.png)

## <a name="step-3b-incremental-crawl-optional"></a>Шаг 3b. Добавотельный обход контента (необязательно)

На этом необязательном шаге SQL запрос для выполнения добавного обхода базы данных. С помощью этого запроса SQL определяет все изменения данных с момента последнего добавального обхода. Как и в полном обходе, выберите все столбцы, в которых нужно выбрать **параметры**"Запрос", **"Поиск"** или **"Получить".** Укажите тот же набор столбцов ACL, который был указан в запросе полного обхода контента.

Компоненты на следующем изображении похожи на компоненты полного обхода за одним исключением. В этом случае выбранным столбцом водяного знака является "ModifiedDateTime". Просмотрите [действия по полному](#step-3a-full-crawl-required) обходу, чтобы узнать, как написать запрос добавного обхода контента, и посмотрите следующее изображение в качестве примера.

![Сценарий добавного обхода контента с свойствами OrderTable, AclTable и примерами, которые можно использовать.](media/MSSQL-incrcrawl.png)

## <a name="step-4-assign-property-labels"></a>Шаг 4. Назначение меток свойств

Следуйте общим [инструкциям по настройке.](https://docs.microsoft.com/microsoftsearch/configure-connector)

<!---If the above phrase does not apply, delete it and insert specific details for your data source that are different from general setup 
instructions.-->

## <a name="step-5-manage-schema"></a>Шаг 5. Управление схемой

Следуйте общим [инструкциям по настройке.](https://docs.microsoft.com/microsoftsearch/configure-connector)
<!---If the above phrase does not apply, delete it and insert specific details for your data source that are different from general setup 
instructions.-->

## <a name="step-6-manage-search-permissions"></a>Шаг 6. Управление разрешениями поиска

Вы можете использовать [ALS,](#full-crawl-manage-search-permissions) указанные на экране полного обхода контента, или переопредить их, чтобы сделать контент видимым для всех.

## <a name="step-7-choose-refresh-settings"></a>Шаг 7. Выбор параметров обновления

Следуйте общим [инструкциям по настройке.](https://docs.microsoft.com/microsoftsearch/configure-connector)
<!---If the above phrase does not apply, delete it and insert specific details for your data source that are different from general setup 
instructions.-->

## <a name="step-8-review-connection"></a>Шаг 8. Проверка подключения

Следуйте общим [инструкциям по настройке.](https://docs.microsoft.com/microsoftsearch/configure-connector)
<!---If the above phrase does not apply, delete it and insert specific details for your data source that are different from general setup 
instructions.-->

## <a name="next-steps-customize-the-search-results-page"></a>Дальнейшие действия: настройка страницы результатов поиска

Создайте собственные вертикали и типы результатов, чтобы конечные пользователи могли просматривать результаты поиска из новых подключений. Без этого шага данные из подключения не будут показываться на странице результатов поиска.

Дополнительные узнать о создании вертикали и MRTs см. в настройках страницы [результатов поиска.](customize-search-page.md)

<!---## Troubleshooting-->

<!---Insert troubleshooting recommendations for this data source-->

## <a name="limitations"></a>Ограничения

Соединители SQL предварительной версии имеют указанные здесь ограничения.

- Соедините SQL Microsoft: в локальной базе данных должна работать SQL версии 2008 или более поздней версии.
- Подписка M365 и подписка Azure (с базой данных Azure SQL) должны быть размещены в одной службе Azure Active Directory.
- ALS поддерживаются только с помощью имени основного пользователя (UPN), Azure Active Directory (Azure AD) или active Directory Security.
- Индексация содержимого в столбцах базы данных не поддерживается. Примерами такого контента являются HTML, JSON, XML, BLOB-элементы и синтаксики документов, которые существуют в качестве ссылок в столбцах базы данных.
